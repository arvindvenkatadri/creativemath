---
title: "Tutorial on Distributions in R"
author: "Arvind Venkatadri"
date: 19/Nov/2022
date-modified: "`r Sys.Date()`"
---

## <iconify-icon icon="noto-v1:package"></iconify-icon> Setup the Packages

```{r}
#| label: setup
#| include: true
#| warning: false
#| message: false
#| echo: true
options(tibble.print_min = 4L, tibble.print_max = 4L)
library(mosaic) # package for stats, simulations, and basic plots
library(mosaicData) # package containing datasets
library(ggformula) # package for professional looking plots, that use the formula interface from mosaic
library(NHANES) # survey data collected by the US National Center for Health Statistics (NCHS)

```

## <iconify-icon icon="fxemoji:japanesesymbolforbeginner"></iconify-icon> Introduction

We will create Distributions for data in R. As always, we will
consistently use the [**Project Mosaic**](https://mosaic-web.org)
ecosystem of packages in R (`mosaic`, `mosaicData` and `ggformula`).

::: {.callout-tip style="background: beige"}
Note the standard method for all commands from the `mosaic` package:

`goal( y ~ x | z, data = mydata, â€¦)`

With `ggformula`, one can create any graph/chart using:

`gf_geometry(y ~ x | z, data = mydata)`

OR

`mydata %>% gf_geometry( y ~ x | z)`

The second method may be preferable, especially if you have done some
data manipulation first! More later!
:::

## Case Study -1: Dataset from `mosaicData`

Let us inspect what datasets are available in the package `mosaicData`.
Type `data(package = "mosaicData")` in your Console to see what datasets
are available.

Let us choose the famous `Galton` dataset:

```{r}
data("Galton")
inspect(Galton)

```

The data is described as:

> A data frame with 898 observations on the following variables.
>
> -   `family` a factor with levels for each family
> -   `father` the father's height (in inches)
> -   `mother` the mother's height (in inches)
> -   `sex` the child's sex: F or M
> -   `height` the child's height as an adult (in inches)
> -   `nkids` the number of adult children in the family, or, at least,
>     the number whose heights Galton recorded.

There is a lot of Description generated by the `mosaic::inspect()`
command ! What can we say about the dataset and its variables? How big
is the dataset? How many variables? What types are they, Quant or Qual?
If they are Qual, what are the *levels*? Are they *ordered* levels?
Discuss!

### Stat Summaries

As Stigler said, **summaries** are the first thing to look at in data.
Let us tabulate some quick stat summaries of the important variables in
`Galton`:

::: column-inset-page
```{r}
favstats(~ father, data = Galton)
favstats(~ height | sex, data = Galton)

```
:::
Story: So fathers are on average taller than mothers on average, in this dataset. 


::: callout-note
Q.1 How many families in the data for each value of `nkids`?
:::

```{r}
tally(~ nkids, data = Galton)
```
Story: There are 32 1-kid families; and $128/8 = 16$ 8-kid families! There is one great great 15-kid family. ( Did you get the idea behind why we divide here?)

::: callout-note
Q.2. What is the break-up by `sex` of the child?
:::

```{r}
tally(~ nkids | sex, data = Galton)
```
Story: Hmm...decent gender balance overall, across families. How would we look for "gender balance" in individual families?

### Distribution Plots

What Questions might we have, that we could answer with a Distribution?

::: callout-note
Q.1 How many families based on the number of children?
:::

```{r}

# Convert the tally into a dataframe. See the difference!
family_count <- 
  tally( ~ nkids | sex, data = Galton) %>% 
  as_tibble() %>% 
  
  # Convert nkids from char to int
  mutate( nkids = as.integer(nkids))
family_count

family_count %>% gf_col(n ~ nkids | sex, 
       fill = ~ sex, 
       ylab = "Number of Families", 
       xlab = "Number of Kids / Family")

```
Story: OK this explains the division we did earlier!


::: callout-note
Q.2: How are the children's heights distributed?
:::

```{r}
gf_histogram(~ height, data = Galton) %>% 
  gf_vline(xintercept = mean(Galton$height))

```
Story: Fairly symmetric distribution...but there are a few very short and some very tall children!


::: callout-note
Q.3: Is there a difference in height distributions between Male and
Female children?
:::

```{r}
measures <- favstats(~ height | sex, data = Galton)
measures

gf_histogram(~ height | sex, data = Galton) %>% 
  gf_vline(xintercept = ~ mean, data = measures)

```
Story: There is a 5 inch difference in average heights between girls and boys. Is that significant, however?


::: callout-note
Q.4: Are Mothers generally shorter than fathers?
:::

```{r}
gf_density(~ father, 
           data = Galton, 
           fill = "blue", 
           alpha = 0.3) %>% 
  
  gf_density( ~ mother, 
              data = Galton, 
              fill = "red", 
              alpha = 0.3, 
              xlab = "Heights")
  
```
Story: Yes moms are on average shorter than dads. Again, is this difference statistically significant?



::: callout-note
Q.5: Are heights of children different based on the number of kids in
the family? For Male and Female children?
:::

```{r}
gf_boxplot(height ~ sex | nkids, data = Galton)

```
Story: Box plots are used to show distributions of numeric data values,
especially when you want to compare them between multiple groups.
So, at all family "strengths", the male children are taller than the female children. 


::: callout-note
Q.6: Does the **mean** height of children in a family vary with the
number of children in the family? ( family size)
:::

```{r}
mean( height ~ sex | nkids, data = Galton) %>% 
  as_tibble() # not very inspiring!

by_sex_nkids <- favstats( height ~ sex + nkids, data = Galton)
by_sex_nkids # much better!

```

```{r}
gf_col(mean ~ sex.nkids, data = by_sex_nkids)

```

Story: Hmm...not a *very* informative plot...the table is better but also not too easy to interpret. But this question is rather similar to Question 5!



## Case Study-2: Dataset from `NHANES`

Let us try the `NHANES` dataset. Try `help(NHANES)` in your Console.

```{r}
data("NHANES")
names(NHANES)

```

### Stat Summaries

```{r}
mosaic::inspect(NHANES)
```

Again, lots of data from `inspect`, about the Quant and Qual variables.
Spend a little time looking through the output of `inspect`. Which
variables could have been data *given* by each respondent, and which
ones could have been *measured* data variables? Why do you think so?\
Why is there so much *missing* data? Which variable are the most
affected by this?

```{r}
tally(~ Education, data = NHANES)
```
Story: The count goes up as we go from lower Education levels to higher. Need to keep that in mind. 


```{r}

tally(Education ~ Work, data = NHANES)

```


Story: Clear increase in the number of Working people as Education goes from 8th Grade to College. No surprise. Is the NotWorking column a surprise?



### Distribution Plots

::: callout-note
Q.1. What is the distribution of Physical Activity Days, across Gender?
Across Education?
:::


```{r}
gf_histogram(data = NHANES, ~ PhysActiveDays | Gender)
gf_histogram(data = NHANES, ~ PhysActiveDays | Education)

```
Story: Can we conclude anything here? The **populations** in each category are different, so what do we need to do? Take percentages or ratios of course, per-capita! How would one do that?

::: callout-note
Q.1a. What is the distribution of Physical Activity Days, across Gender, per capita?
Across Education?
:::

```{r}

NHANES %>% 
  group_by(Gender) %>% 
  summarize(mean_active = mean(PhysActiveDays,na.rm = TRUE))

NHANES %>% 
  group_by(Education) %>% 
  summarize(mean_active = mean(PhysActiveDays,na.rm = TRUE))

```

Story: Hmm..no great differences. Females are maginally more active than males.



::: callout-note
Q.2. How are people Ages distributed across levels of Education?
:::

```{r}
gf_boxplot(Age ~ Education, 
           fill = ~ Education, # Always a good idea
           data = NHANES)
```

Story: Older age groups are more heavily represented in groups with lover educational status. 
How to interpret the NA group?


::: callout-note
Q.3. How is Education distributed over Race?
:::

```{r}

NHANES_by_Race1 <- NHANES %>% 
  group_by(Race1) %>% summarize(population = n())
NHANES_by_Race1

NHANES %>% group_by(Education, Race1) %>% 
  summarize( n = n()) %>% 
  left_join(NHANES_by_Race1, by = c("Race1" = "Race1")) %>% 
  mutate(percapita_educated = (n/population)*100) %>% 
  ungroup() %>%  # not really needed
  gf_col(Education ~ percapita_educated | Race1, fill = ~ Race1)

```
Story: Blacks, Hispanics, and Mexicans tend to have fewer people with college degrees, as a percentage of their population.


::: callout-note
Q.4. What is the distribution of people's BMI, split by Gender? By
Race1?
:::

```{r}
# One can also plot both histograms and densities in an overlay fashion,
gf_dhistogram(~ BMI | Gender, data = NHANES) %>% 
      gf_fitdistr(dist = "dnorm") 



gf_dhistogram(~ BMI, data = NHANES) %>% 
    gf_fitdistr(dist = "dnorm") %>% 
  gf_refine(facet_wrap(~ Race1, scales = "free"))
            
```

Story: Non-white races tend to have larger portions of their populations with larger BMI. So these races perhaps tend to obesity. By and large BMI distributions are normal. 


::: callout-note
Q.4. What is the distribution of people's Testosterone level vs BMI? Split By
Race1?
:::


```{r}
NHANES %>%  gf_density2d(Testosterone ~ BMI | Race1) 

```
Story: Low testosterone levels exist across all BMI values, but healthy levels of T exists only over a smaller range of BMI. 

## Case Study-3: A complete example

Here is a dataset from Jeremy Singer-Vine's blog, [Data Is
Plural](https://www.data-is-plural.com/). This is a list of all books
banned in schools across the US.

{{< downloadthis data/banned.csv dname="banned.csv" label="Download the data"banned books icon="database-fill-down" type="info" >}}

```{r, bar-charts}
banned <- readxl::read_xlsx(path = "data/banned.xlsx",
                            sheet = "Sorted by Author & Title")
banned

names(banned)

```

Clearly the variables are *all* Qualitative, except perhaps for *Date of
Challenge/Removal, (which in this case has been badly mangled by Excel)
So we need to make **counts** based on the* levels\* of the Qual
variables and plot Bar/Column charts.

Let us quickly make some Stat Summaries ( using `inspect`)

```{r}
mosaic::inspect(banned)

```

Let us try to answer this question:

::: callout-important
*What is the count of banned books by type and by US state?*
:::

```{r}
banned_by_state <- 
  banned %>% 
  group_by(State) %>% 
  summarise(total = n()) %>% 
  ungroup()
banned_by_state

banned %>% 
  group_by(State, `Type of Ban`) %>% 
  summarise(count = n()) %>% 
  ungroup() %>% 
  left_join(., banned_by_state, by = c("State" = "State")) %>% 
  
 #  pivot_wider(.,id_cols = State,
 #              names_from = `Type of Ban`,
 #              values_from = count) %>% janitor::clean_names() %>% 
 #  replace_na(list(banned_from_libraries_and_classrooms = 0,
 #                  banned_from_libraries = 0,
 #                  banned_pending_investigation = 0,
 #                  banned_from_classrooms = 0)) %>% 
 # mutate(total = sum(across(where(is.integer)))) %>%
gf_col(count ~ reorder(State, total), 
          fill = ~ `Type of Ban`) %>% 
  gf_labs(x = "Count of Banned Books",
          y = "State") %>% 
  gf_refine(coord_flip()) %>% 
  gf_theme(theme = theme_minimal())


```

# References

1.  A detailed analysis of the NHANES dataset,
    <https://awagaman.people.amherst.edu/stat230/Stat230CodeCompilationExampleCodeUsingNHANES.pdf>

---
title: <iconify-icon icon="maki:watermill"></iconify-icon> Sankey, Alluvial, and Parallet-Set Plots
subtitle: "Yes...On the River, In the River, With the River..."
date: 2024-April-22
date-modified: "`r Sys.Date()`"
order: 28
lightbox: true
abstract: "Changes in Information over Space and Time"
categories:
- Qual Variables and Quant Variables
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(blogdown)
library(tidyverse)
library(downloadthis)
library(knitr)
library(kableExtra)


# ![An Elephant](elephant.png){#fig-elephant}
# This is illustrated well by @fig-elephant.
# ### Figure Panel Divs
#     ::: {#fig-elephants layout-ncol=2}
#     ![Surus](surus.png){#fig-surus}
#     ![Hanno](hanno.png){#fig-hanno}
#      Famous Elephants
#     :::

```

## What graphs will we see today?
| Variable #1 | Variable #2 | Chart Names |                    Chart Shape                    |
|:-------------:|:--------------:|:------------------:|:--------------------:|
|    Quant    |    None     |  Sankey Plot | {{< iconify carbon sankey-diagram-alt size=4x >}}  {{< iconify carbon chart-parallel size=4x  >}} |



::: column-page-inset-right
```{r}
#| message: false
#| echo: false
#| warning: false
read_csv("../../../../materials/Data/pronouns.csv") %>% 
  filter(No %in% c("2","3")) %>% 
  kbl() %>%
  kable_paper("hover", full_width = T)
  
```
:::

## {{< iconify mdi food-processor-outline >}} How do these Chart(s) Work?
Sometimes Qual data can itself vary over, or depend upon, over a bunch of independent Qual data *categories*. For instance we can contemplate enrollment at a University, and show how students move from course to course in a University. Or how customers drift from one category of products or brands to another....or the movement of cricket players from one IPL Team to another !!

As can be surmised, the independent *categories* can be interpreted both as **time** ( e.g semesters / cycles / years) and **space** (teams / courses / departments). And we can chart another Quant or Qual variable that moves across levels of the first chosen Qual variable.

![](../../../../materials/images/sankey.png){fig-align="center" width="800"}

-   The Qualitative variables being connected are mapped to
    `stages/axes`
-   Each *level* within a Qual variable is mapped to
    `nodes / strata / lodes`;
-   And the connections between the `strata` of the `axes` are called
    `flows / links / alluvia`.\

Such diagrams are best used when you want to show a many-to-many mapping
between two domains or multiple paths through a set of stages E.g
Students going through multiple courses during a semester of study.

Here is an example of a Sankey Diagram for the `Titanic` dataset:

```{r}
#| echo: false
#| message: false
#| label: fig-titanic-sankey-plot
#| fig-cap: "Titanic Sankey Plot"
theme_set(theme_classic())
##
library(ggalluvial)
data("Titanic")
Titanic <- Titanic %>% as_tibble()

Titanic %>% ggplot(data = .,
    
# Select the Categorical Variables for the vertical Axes / Stages
       aes(axis1 = Class, 
           axis2 = Sex, 
           axis3 = Age,
           axis4 = Survived,
           y = n), fill = "white") +
  
# Alluvials between Categorical Axes
  geom_alluvium(aes(fill = Survived), 
                colour = "black", 
                linewidth = 0.25) +
  
# Vertical segments for each Categorical Variable2 
  geom_stratum(colour = "black", 
               linewidth = 1, 
               fill = "white") + 
  
# Labels for each "level" of the Categorical Axes
  geom_text(stat = "stratum", 
            aes(label = after_stat(stratum))) +
  

  
# Scales and Colours
  scale_x_discrete(limits = c("Class", "Sex", "Age"), 
                   expand = c(.2, .05)) +
  
  scale_fill_manual(values = c("red", "green")) + 
  
  xlab("Demographic") +
  ggtitle("Passengers on the maiden voyage of the Titanic",
          "Stratified by demographics and survival")

```

It is seen from @fig-titanic-sankey-plot that the x-axis has Qual variables `stages` shown as "pillars" and these are split into `nodes` based on the levels for each Qual variable `stage` respectively. 
`Flows` with variable thickness connect one `node` at one `stage` to another `node` and another `stage`. 

::: callout-note
### Sankey, Parallel sets, and Alluvial Charts
Here is what [Thomas Lin Pedersen](https://ggforce.data-imaginist.com/reference/geom_parallel_sets.html)
says:

A **parallel sets diagram** is a type of visualisation showing the interaction between multiple categorical variables. 

If the variables have an **intrinsic order** the representation can be thought of as a **Sankey Diagram**.

If each variable is a point in time it will resemble an **Alluvial diagram**.

:::



## {{< iconify carbon box-plot >}} {{< iconify carbon chart-violin-plot >}} Creating Sankey Plots

::: {.panel-tabset .nav-pills style="background: whitesmoke;"}

### Using Orange
It does not seem possible to create an Alluvial Diagram in Orange. `r emoji::emoji("cry")`

### Using RAWgraphs

{{< video https://youtu.be/6BYac2Pmnno >}}

{{< downloadthis AlluvialDiagram/TutorialAlluvialDiagram.rawgraphs dname="TutorialAlluvialDiagram" label="Download the RAWgraphs Alluvial Tutorial File" icon="database-fill-down" type="info" >}}

Download this file and upload to <https://app.rawgraphs.io/>.

Let us however examine this data in Orange:

{{< downloadthis AlluvialDiagram/2020HateCrimesInNY.csv dname="HateCrimesInNY" label="Download the Hate Crimes dataset" icon="database-fill-down" type="info" >}}

![Hate Crimes in NY 2020](../../../../materials/images/Orange/hate-crimes-data-table.png){#fig-hate-crime-data-table}

From the @fig-hate-crime-data-table, We see that the data is all Qualitative, except for `Age`. The `Precinct`, while apparently an integer, is really a Qual variable! Why?

And here is the Sankey Diagram:

![Hate Crime Sankey Diagram](AlluvialDiagram/TutorialAlluvialDiagram.png){#fig-hate-crime-sankey}


In the @fig-hate-crime-sankey, we have three Qual variables along the x-axis: `Gender`, `Race` and `Bias-Motivation`. The chart *counts* the crime episodes at each `stage/node` and portrays them as flows with varying thickness leading to the next `stage/node`. 

What trends do you detect from this diagram?

### Using DataWrapper

It does not seem possible to create an Alluvial Diagram in DataWrapper. 

:::


## {{< iconify uiw pay >}} Dataset: Vaccinations

Let us try one more dataset:

Let us at least examine this dataset in Orange.

{{< downloadthis data/salaries.csv dname="salaries" label="Download the Salaries data" icon="database-fill-down" type="info" >}}

### {{< iconify file-icons influxdata >}} Examine the Data




### {{< iconify streamline dictionary-language-book-solid >}} Data Dictionary

::: callout-note
### Quantitative Data


:::

::: callout-note
### Qualitative Data

:::


### {{< iconify material-symbols query-stats >}} Research Questions

Let's try a few questions and see if they are answerable with Box Plots and Violins

::: callout-note
## Question
Q1. 

::: {#fig-netflix-histograms layout-ncol=2}


:::

:::

::: callout-note
## Question
Q2. 

:::


### {{< iconify game-icons secret-book >}} What is the Story Here?

[*statistical ANOVA test*]{style="background: yellow;"}. 



## {{< iconify bi person-up >}} Your Turn

1.  Within the `ggalluvial` package are two datasets, `majors` and
    `vaccinations`. Plot alluvial charts for both of these.
2.  Go to the [American Life Panel
    Website](https://alpdata.rand.org/index.php?page=data) where you
    will find many public datasets. Try to take one and make charts from
    it that we have learned in this Module.


## {{< iconify mingcute thought-line >}} Wait, But Why?




## {{< iconify ooui references-ltr >}} References

{
  "hash": "db397af3b6a09a595bde6678fb6d3694",
  "result": {
    "markdown": "---\ntitle: \"Correlations in R\"\nauthor: \"Arvind Venkatadri\"\ndate: \"2023-05-15\"\nabstract: Tests, Tables, and Graphs for Correlations in R\ncode-tools: true\n---\n\n\n# Introduction\n\nWe will create Tables for Correlations, and graphs for Correlations in\nR. As always, we will consistently use the [**Project\nMosaic**](https://mosaic-web.org) ecosystem of packages in R (`mosaic`,\n`mosaicData` and `ggformula`).\n\n\n::: {.cell hash='correlations_cache/html/setup_b6e93a8ad02db57b07bd39b8ae7865b3'}\n\n```{.r .cell-code}\nlibrary(tidyverse)\nlibrary(mosaic) # package for stats, simulations, and basic plots\nlibrary(mosaicData) # package containing datasets\nlibrary(ggformula) # package for professional looking plots, that use the formula interface from mosaic\nlibrary(NHANES) # survey data collected by the US National Center for Health Statistics (NCHS)\nlibrary(corrplot) # For Correlogram plots\n```\n:::\n\n\n::: {.callout-tip style=\"background: beige\"}\nNote the standard method for all commands from the `mosaic` package:\n\n`goal( y ~ x | z, data = mydata, â€¦)`\n\nWith `ggformula`, one can create any graph/chart using:\n\n`gf_geometry(y ~ x | z, data = mydata)`\n\nOR\n\n`mydata %>% gf_geometry( y ~ x | z)`\n\nThe second method may be preferable, especially if you have done some\ndata manipulation first! More later!\n:::\n\n## Case Study -1: Dataset from `mosaicData`\n\nLet us inspect what datasets are available in the package `mosaicData`.\nRun this command in your Console:\n\n\n::: {.cell hash='correlations_cache/html/unnamed-chunk-2_b298f83ad85523fcb2e7de7072f05b5c'}\n\n```{.r .cell-code}\n# Run in Console\ndata(package = \"mosaicData\")\n```\n:::\n\n\nThe popup tab shows a lot of datasets we could use. Let us continue to\nuse the famous `Galton` dataset and `inspect` it:\n\n\n::: {.cell hash='correlations_cache/html/unnamed-chunk-3_9859fe2e41946e231419c10ed68145e9'}\n\n```{.r .cell-code}\ndata(\"Galton\")\ninspect(Galton)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n\ncategorical variables:  \n    name  class levels   n missing\n1 family factor    197 898       0\n2    sex factor      2 898       0\n                                   distribution\n1 185 (1.7%), 166 (1.2%), 66 (1.2%) ...        \n2 M (51.8%), F (48.2%)                         \n\nquantitative variables:  \n    name   class min Q1 median   Q3  max      mean       sd   n missing\n1 father numeric  62 68   69.0 71.0 78.5 69.232851 2.470256 898       0\n2 mother numeric  58 63   64.0 65.5 70.5 64.084410 2.307025 898       0\n3 height numeric  56 64   66.5 69.7 79.0 66.760690 3.582918 898       0\n4  nkids integer   1  4    6.0  8.0 15.0  6.135857 2.685156 898       0\n```\n:::\n:::\n\n\nThe `inspect` command already gives us a series of statistical measures\nof different variables of interest. As discussed previously, we can\nretain the output of `inspect` and use it in our reports: (there are\nways of dressing up these tables too)\n\n\n::: {.cell hash='correlations_cache/html/Galton-inspect_2e29ef3219487bd823d9e4c4282213f6'}\n\n```{.r .cell-code}\ngalton_describe <- inspect(Galton)\n\ngalton_describe$categorical\n```\n\n::: {.cell-output-display}\n`````{=html}\n<div data-pagedtable=\"false\">\n  <script data-pagedtable-source type=\"application/json\">\n{\"columns\":[{\"label\":[\"name\"],\"name\":[1],\"type\":[\"chr\"],\"align\":[\"left\"]},{\"label\":[\"class\"],\"name\":[2],\"type\":[\"chr\"],\"align\":[\"left\"]},{\"label\":[\"levels\"],\"name\":[3],\"type\":[\"int\"],\"align\":[\"right\"]},{\"label\":[\"n\"],\"name\":[4],\"type\":[\"int\"],\"align\":[\"right\"]},{\"label\":[\"missing\"],\"name\":[5],\"type\":[\"int\"],\"align\":[\"right\"]},{\"label\":[\"distribution\"],\"name\":[6],\"type\":[\"chr\"],\"align\":[\"left\"]}],\"data\":[{\"1\":\"family\",\"2\":\"factor\",\"3\":\"197\",\"4\":\"898\",\"5\":\"0\",\"6\":\"185 (1.7%), 166 (1.2%), 66 (1.2%) ...\"},{\"1\":\"sex\",\"2\":\"factor\",\"3\":\"2\",\"4\":\"898\",\"5\":\"0\",\"6\":\"M (51.8%), F (48.2%)\"}],\"options\":{\"columns\":{\"min\":{},\"max\":[10]},\"rows\":{\"min\":[10],\"max\":[10]},\"pages\":{}}}\n  </script>\n</div>\n`````\n:::\n\n```{.r .cell-code}\ngalton_describe$quantitative\n```\n\n::: {.cell-output-display}\n`````{=html}\n<div data-pagedtable=\"false\">\n  <script data-pagedtable-source type=\"application/json\">\n{\"columns\":[{\"label\":[\"\"],\"name\":[\"_rn_\"],\"type\":[\"\"],\"align\":[\"left\"]},{\"label\":[\"name\"],\"name\":[1],\"type\":[\"chr\"],\"align\":[\"left\"]},{\"label\":[\"class\"],\"name\":[2],\"type\":[\"chr\"],\"align\":[\"left\"]},{\"label\":[\"min\"],\"name\":[3],\"type\":[\"dbl\"],\"align\":[\"right\"]},{\"label\":[\"Q1\"],\"name\":[4],\"type\":[\"dbl\"],\"align\":[\"right\"]},{\"label\":[\"median\"],\"name\":[5],\"type\":[\"dbl\"],\"align\":[\"right\"]},{\"label\":[\"Q3\"],\"name\":[6],\"type\":[\"dbl\"],\"align\":[\"right\"]},{\"label\":[\"max\"],\"name\":[7],\"type\":[\"dbl\"],\"align\":[\"right\"]},{\"label\":[\"mean\"],\"name\":[8],\"type\":[\"dbl\"],\"align\":[\"right\"]},{\"label\":[\"sd\"],\"name\":[9],\"type\":[\"dbl\"],\"align\":[\"right\"]},{\"label\":[\"n\"],\"name\":[10],\"type\":[\"int\"],\"align\":[\"right\"]},{\"label\":[\"missing\"],\"name\":[11],\"type\":[\"int\"],\"align\":[\"right\"]}],\"data\":[{\"1\":\"father\",\"2\":\"numeric\",\"3\":\"62\",\"4\":\"68\",\"5\":\"69.0\",\"6\":\"71.0\",\"7\":\"78.5\",\"8\":\"69.232851\",\"9\":\"2.470256\",\"10\":\"898\",\"11\":\"0\",\"_rn_\":\"1\"},{\"1\":\"mother\",\"2\":\"numeric\",\"3\":\"58\",\"4\":\"63\",\"5\":\"64.0\",\"6\":\"65.5\",\"7\":\"70.5\",\"8\":\"64.084410\",\"9\":\"2.307025\",\"10\":\"898\",\"11\":\"0\",\"_rn_\":\"2\"},{\"1\":\"height\",\"2\":\"numeric\",\"3\":\"56\",\"4\":\"64\",\"5\":\"66.5\",\"6\":\"69.7\",\"7\":\"79.0\",\"8\":\"66.760690\",\"9\":\"3.582918\",\"10\":\"898\",\"11\":\"0\",\"_rn_\":\"3\"},{\"1\":\"nkids\",\"2\":\"integer\",\"3\":\"1\",\"4\":\"4\",\"5\":\"6.0\",\"6\":\"8.0\",\"7\":\"15.0\",\"8\":\"6.135857\",\"9\":\"2.685156\",\"10\":\"898\",\"11\":\"0\",\"_rn_\":\"4\"}],\"options\":{\"columns\":{\"min\":{},\"max\":[10]},\"rows\":{\"min\":[10],\"max\":[10]},\"pages\":{}}}\n  </script>\n</div>\n`````\n:::\n:::\n\n\nTry `help(\"Galton\")` in your Console. The dataset is described as:\n\n> A data frame with 898 observations on the following variables.\\\n> - `family` a factor with levels for each family\\\n> - `father` the father's height (in inches)\\\n> - `mother` the mother's height (in inches)\\\n> - `sex` the child's sex: F or M\\\n> - `height` the child's height as an adult (in inches)\\\n> - `nkids` the number of adult children in the family, or, at least,\n> the number whose heights Galton recorded.\n\nThere is a lot of Description generated by the `mosaic::inspect()`\ncommand ! What can we say about the dataset and its variables? How big\nis the dataset? How many variables? What types are they, Quant or Qual?\nIf they are Qual, what are the *levels*? Are they *ordered* levels?\nDiscuss!\n\n## Correlations and Plots\n\nWhat Questions might we have, that we could answer with a Statistical\nMeasure, or Correlation chart?\n\nQ.1 Which are the variables that have significant pair-wise\ncorrelations? What polarity are these correlations?\n\n\n::: {.cell hash='correlations_cache/html/unnamed-chunk-4_b6eebb35311d48caf96acb8999f8dfa5'}\n\n```{.r .cell-code}\n# Pulling out the list of Quant variables from NHANES\ngalton_quant <- galton_describe$quantitative\ngalton_quant$name\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n[1] \"father\" \"mother\" \"height\" \"nkids\" \n```\n:::\n\n```{.r .cell-code}\nGGally::ggpairs(\n  Galton,\n  columns = c(\"father\", \"mother\", \"height\", \"nkids\"),\n  diag = list(\"densityDiag\"),\n  title = \"Galton Data Correlations Plot\"\n)\n```\n\n::: {.cell-output-display}\n![](correlations_files/figure-html/unnamed-chunk-4-1.png){width=672}\n:::\n:::\n\n\nCan we plot a Correlogram for this dataset?\n\n\n::: {.cell hash='correlations_cache/html/unnamed-chunk-5_f2d46e27baec78d8060b5a242c2ac52a'}\n\n```{.r .cell-code}\n#library(corrplot)\n\ngalton_num_var <- Galton %>% select(father, mother, height, nkids)\ngalton_cor <- cor(galton_num_var)\ngalton_cor %>%\n  corrplot(method = \"ellipse\",\n           type = \"lower\",\n           main = \"Correlogram for Galton dataset\")\n```\n\n::: {.cell-output-display}\n![](correlations_files/figure-html/unnamed-chunk-5-1.png){width=672}\n:::\n:::\n\n\nClearly `height` is positively correlated to `father` and `mother`;\ninterestingly, `height` is negatively correlated ( slightly) with\n`nkids`.\n\nQ.2: Let us confirm with a test:\n\n\n::: {.cell hash='correlations_cache/html/unnamed-chunk-6_b3ec87f54fc388917c8df77f0a72511e'}\n\n```{.r .cell-code}\nmosaic::cor_test(height ~ father, data = Galton)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n\n\tPearson's product-moment correlation\n\ndata:  height and father\nt = 8.5737, df = 896, p-value < 2.2e-16\nalternative hypothesis: true correlation is not equal to 0\n95 percent confidence interval:\n 0.2137851 0.3347455\nsample estimates:\n      cor \n0.2753548 \n```\n:::\n:::\n\n::: {.cell hash='correlations_cache/html/unnamed-chunk-7_7dbe297f6d92244be2f3f5698325d1c4'}\n\n```{.r .cell-code}\nmosaic::cor_test(height ~ mother, data = Galton)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n\n\tPearson's product-moment correlation\n\ndata:  height and mother\nt = 6.1628, df = 896, p-value = 1.079e-09\nalternative hypothesis: true correlation is not equal to 0\n95 percent confidence interval:\n 0.1380554 0.2635982\nsample estimates:\n      cor \n0.2016549 \n```\n:::\n:::\n\n\nQ.3 What does this correlation look when split by `sex` of Child?\n\nWe will use the `mosaic` function `cor_test` to get these results:\n\n\n::: {.cell hash='correlations_cache/html/unnamed-chunk-8_40dd28badefe634ce571a837af0636f8'}\n\n```{.r .cell-code}\n# For the sons\nmosaic::cor_test(height ~ father, data = Galton %>% filter(sex == \"M\"))\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n\n\tPearson's product-moment correlation\n\ndata:  height and father\nt = 9.1498, df = 463, p-value < 2.2e-16\nalternative hypothesis: true correlation is not equal to 0\n95 percent confidence interval:\n 0.3114667 0.4656805\nsample estimates:\n      cor \n0.3913174 \n```\n:::\n\n```{.r .cell-code}\ncor_test(height ~ mother, data = Galton %>% filter(sex == \"M\"))\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n\n\tPearson's product-moment correlation\n\ndata:  height and mother\nt = 7.628, df = 463, p-value = 1.367e-13\nalternative hypothesis: true correlation is not equal to 0\n95 percent confidence interval:\n 0.2508178 0.4125305\nsample estimates:\n      cor \n0.3341309 \n```\n:::\n\n```{.r .cell-code}\n# For the daughters\ncor_test(height ~ father, data = Galton %>% filter(sex == \"F\"))\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n\n\tPearson's product-moment correlation\n\ndata:  height and father\nt = 10.719, df = 431, p-value < 2.2e-16\nalternative hypothesis: true correlation is not equal to 0\n95 percent confidence interval:\n 0.3809944 0.5300812\nsample estimates:\n      cor \n0.4587605 \n```\n:::\n\n```{.r .cell-code}\ncor_test(height ~ mother, data = Galton %>% filter(sex == \"F\"))\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n\n\tPearson's product-moment correlation\n\ndata:  height and mother\nt = 6.8588, df = 431, p-value = 2.421e-11\nalternative hypothesis: true correlation is not equal to 0\n95 percent confidence interval:\n 0.2261463 0.3962226\nsample estimates:\n      cor \n0.3136984 \n```\n:::\n:::\n\n\n::: callout-important\n## Correlation Scores and Uncertainty\n\nNote how the `cor.test` reports a correlation score and the `p-value`\nfor the same. There is also a `confidence interval` reported for the\ncorrelation score, an interval within which we are 95% sure that the\ntrue correlation value is to be found. Note that GGally too reports the\nsignificance of the correlation scores using `***` or `**`. This\nindicates the p-value in the scores obtained by GGally; Presumably,\nthere is an internal `cor.test` that is run for each pair of variables\nand the p-value and confidence levels are also computed internally.\n:::\n\nWe can also visualise this uncertainty and the confidence levels in a\nplot too, using `gf_errorbar` and a handy set of functions within\n`purrr` which is part of the tidyverse: Assuming `heights` is the\nvariable we want to correlate every other (quantitative) variable\nagainst, we can proceed very quickly as follows:\n\n\n::: {.cell hash='correlations_cache/html/corrtest plots_f4e7e934950701185c438c8971c922e1'}\n\n```{.r .cell-code}\nall_corrs <- Galton %>% \n  select(where(is.numeric)) %>% \n  \n  # leave off height to get all the remaining ones\n  select(- height) %>%  \n  \n  # perform a cor.test for all variables against height\n  purrr::map(.x = .,\n             .f = \\(x) cor.test(x, Galton$height)) %>%\n  \n  # tidy up the cor.test outputs into a tidy data frame\n  map_dfr(broom::tidy, .id = \"predictor\") \n\nall_corrs\n```\n\n::: {.cell-output-display}\n`````{=html}\n<div data-pagedtable=\"false\">\n  <script data-pagedtable-source type=\"application/json\">\n{\"columns\":[{\"label\":[\"predictor\"],\"name\":[1],\"type\":[\"chr\"],\"align\":[\"left\"]},{\"label\":[\"estimate\"],\"name\":[2],\"type\":[\"dbl\"],\"align\":[\"right\"]},{\"label\":[\"statistic\"],\"name\":[3],\"type\":[\"dbl\"],\"align\":[\"right\"]},{\"label\":[\"p.value\"],\"name\":[4],\"type\":[\"dbl\"],\"align\":[\"right\"]},{\"label\":[\"parameter\"],\"name\":[5],\"type\":[\"int\"],\"align\":[\"right\"]},{\"label\":[\"conf.low\"],\"name\":[6],\"type\":[\"dbl\"],\"align\":[\"right\"]},{\"label\":[\"conf.high\"],\"name\":[7],\"type\":[\"dbl\"],\"align\":[\"right\"]},{\"label\":[\"method\"],\"name\":[8],\"type\":[\"chr\"],\"align\":[\"left\"]},{\"label\":[\"alternative\"],\"name\":[9],\"type\":[\"chr\"],\"align\":[\"left\"]}],\"data\":[{\"1\":\"father\",\"2\":\"0.2753548\",\"3\":\"8.573704\",\"4\":\"4.354588e-17\",\"5\":\"896\",\"6\":\"0.2137851\",\"7\":\"0.33474554\",\"8\":\"Pearson's product-moment correlation\",\"9\":\"two.sided\"},{\"1\":\"mother\",\"2\":\"0.2016549\",\"3\":\"6.162793\",\"4\":\"1.079105e-09\",\"5\":\"896\",\"6\":\"0.1380554\",\"7\":\"0.26359819\",\"8\":\"Pearson's product-moment correlation\",\"9\":\"two.sided\"},{\"1\":\"nkids\",\"2\":\"-0.1269101\",\"3\":\"-3.829800\",\"4\":\"1.371780e-04\",\"5\":\"896\",\"6\":\"-0.1907472\",\"7\":\"-0.06200411\",\"8\":\"Pearson's product-moment correlation\",\"9\":\"two.sided\"}],\"options\":{\"columns\":{\"min\":{},\"max\":[10]},\"rows\":{\"min\":[10],\"max\":[10]},\"pages\":{}}}\n  </script>\n</div>\n`````\n:::\n\n```{.r .cell-code}\nall_corrs %>% \n  gf_point(estimate ~ reorder(predictor, estimate)) %>% \n  gf_errorbar(conf.high + conf.low ~ reorder(predictor, estimate),\n              color = ~ -log10(p.value),\n              width = 0.2) %>% \n  gf_hline(yintercept = 0, color = \"grey\", linewidth = 2) %>% \n  gf_labs(x = NULL, y = \"Correlation with height in Galton\") %>% \n  gf_theme(theme_minimal()) %>% \n  gf_refine(scale_color_gradient(\"significance\",low = \"grey\", high = \"red\"))\n```\n\n::: {.cell-output-display}\n![](correlations_files/figure-html/corrtest plots-1.png){width=672}\n:::\n:::\n\n\nWe can clearly see the size of the correlations and the confidence\nintervals marked in this plot. `father` has somewhat greater correlation\nwith children's `height`, as compared to `mother`. `nkids` seems to\nmatter very little. This kind of plot will be very useful when we pursue\nlinear regression models.\n\nQ.4. How can we show this correlation in a set of Scatter Plots +\nRegression Lines? Can we recreate Galton's famous diagram?\n\n\n::: {.cell hash='correlations_cache/html/unnamed-chunk-10_2e8117771ccd129098874bcb6b1569b3'}\n\n```{.r .cell-code}\n# For the sons\ngf_point(height ~ father, data = Galton %>% \n           filter(sex == \"M\")) %>% gf_smooth(method = \"lm\")\n```\n\n::: {.cell-output-display}\n![](correlations_files/figure-html/unnamed-chunk-10-1.png){width=672}\n:::\n\n```{.r .cell-code}\ngf_point(height ~ mother, data = Galton %>% \n           filter(sex == \"M\")) %>% gf_smooth(method = \"lm\")\n```\n\n::: {.cell-output-display}\n![](correlations_files/figure-html/unnamed-chunk-10-2.png){width=672}\n:::\n\n```{.r .cell-code}\n# For the daughters\ngf_point(height ~ father, data = Galton %>% \n           filter(sex == \"F\")) %>% \n  gf_smooth(method = \"lm\")\n```\n\n::: {.cell-output-display}\n![](correlations_files/figure-html/unnamed-chunk-10-3.png){width=672}\n:::\n\n```{.r .cell-code}\ngf_point(height ~ mother, data = Galton %>% \n           filter(sex == \"F\")) %>% \n  gf_smooth(method = \"lm\")\n```\n\n::: {.cell-output-display}\n![](correlations_files/figure-html/unnamed-chunk-10-4.png){width=672}\n:::\n:::\n\n\nAn approximation to Galton's famous plot (see Wikipedia):\n\n\n::: {.cell hash='correlations_cache/html/unnamed-chunk-11_c18101e89b1fbadb37c5be570c69fe7c'}\n\n```{.r .cell-code}\ngf_point(height ~ (father + mother)/2, data = Galton) %>% \n  gf_smooth(method = \"lm\") %>% \n  gf_density_2d(n = 8) %>% \n  gf_abline(slope = 1)\n```\n\n::: {.cell-output-display}\n![](correlations_files/figure-html/unnamed-chunk-11-1.png){width=672}\n:::\n:::\n\n\nHow would you interpret this plot?\n\n## Case Study -2: Dataset from `NHANES`\n\nWe will \"live code\" this in class!\n\n# Conclusion\n\nWe have a decent Correlations related *workflow* in R:\\\n- load the dataset\\\n- `inspect` the dataset, identify Quant and Qual variables\\\n- Develop Pair-Wise plots + Correlations using `GGally::ggpairs()`\\\n- Develop Correlogram `corrplot::corrplot`\\\n- Check everything with a `cor_test`\\\n- Plot scatter plots using `gf_point` if needed.\\\n- Add extra lines using `gf_abline()` to compare hypotheses that you may\nhave.\n",
    "supporting": [],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {
      "include-in-header": [
        "<link href=\"../../../../../../../site_libs/pagedtable-1.1/css/pagedtable.css\" rel=\"stylesheet\" />\r\n<script src=\"../../../../../../../site_libs/pagedtable-1.1/js/pagedtable.js\"></script>\r\n"
      ]
    },
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}